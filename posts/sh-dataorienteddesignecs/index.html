
<!doctype html>
<html>

<head>
  <title>  A Completely New Approach: An ECS Programming Language  </title>

  <meta charset="utf-8">

  
  <link rel="stylesheet" href="https://nttdata-dach.github.io/css/main.css">
  <link rel="stylesheet" href="https://nttdata-dach.github.io/css/syntax.css">
  <link href="" rel="feed" type="application/rss+xml" title="Technology Blog" />
  <script src="https://kit.fontawesome.com/ed40ccf940.js" crossorigin="anonymous"></script>
  <script src="reading-time.js"></script>
</head>

<body>
  <header>
    <a href="/"><img src="/images/NTT-Data-white.png"></a>

    <nav>

      
        <a   class="emphasized" 
           href="/posts">All Blogposts</a>
      
        <a target="_blank"   
           href="mailto:techblog@nttdata.com">Contact</a>
      
        <a target="_blank"   
           href="https://de.nttdata.com/">About Us</a>
      

      <a target="_blank" class="github" href="https://github.com/NTTDATA-DACH/"><img src="/images/GitHub.png"></a>
    </nav>
  </header>



  <div class="emobanner article">
    <h1>
        <span class="pre">09.03.2023
        
         - Sascha Hampl - <i class="fa-solid fa-book-open"></i> 10 min read
        
        </span>
        A Completely New Approach: An ECS Programming Language
        
    </h1>

    
        <div class="article-header-img" style="background: url('/posts/img/SH-DataOrientedDesignECS/title-image.jpg') no-repeat center center; background-size: cover">
            <div class="article-header-gradient" style="background: linear-gradient(to right, rgba(16, 28, 81,1), rgba(255,0,0,0));width:80%; left:0"></div>
        </div> 
    


    
</div>

<main>
    
    <div class="container">
        <div class="spacer"></div>
        <div class="content">
            
           
            <h1 id="structure-of-this-blog">Structure of this Blog</h1>
<p>At the start we have an introduction as to what Data-Oriented Design (DOD) is used for, what the problem with current popular paradigms in the business space is and how we can solve them with DOD.
This is followed by a technical section that will explain some of the concepts of DOD with examples. 
At the end, I will show the usage of ECS and list some frameworks.</p>
<h1 id="introduction">Introduction</h1>
<p>DOD was used a decade ago predominantly by the video game industry. Back when a complex game had to fit on something like a 32MB cartridge. Humans had to find ways to think more like a computer to make data fit and make their programs run more efficient.</p>
<h2 id="the-problem-with-current-paradigms">The Problem with current Paradigms</h2>
<p>With computers becoming more powerful we had to concern ourselves less and less with performance. So we slowly moved to less efficient and easier to read/write ways of programming. However, by paying less attention to performance we are required to invest more money into hardware. It is not really significant for a small app, but at enterprise scale - where massive amounts of datasets need to be processed every second with an extra layer of redundancy - costs explode.</p>
<h2 id="what-is-dod">What is DOD?</h2>
<p>Data-Oriented Design is more of top-level paradigm on the level of OOP/Functional Programming that makes data a first-class citizen.</p>
<p>ECS or Entity Component System is a macroarchitectural pattern that lives in the DOD world.</p>
<p>SoA or Struct of Array is an example of a microarchitectural DOD pattern.</p>
<h2 id="how-can-it-solve-our-problem">How can it solve our Problem?</h2>
<p>Now as with any other top-level paradigm we can extract parts of it and use it where it yields us the most benefit.
If used correctly, ECS can improve performance up to 100x. You can find an example of performance increase in this video by Nomans Skywalker on <a href="https://www.youtube.com/watch?v=rcnWWzJwTOc">YouTube</a>.</p>
<p>In my opinion, DOD shows its best side when it is used in a message-driven/stream architecture, because the ECS pattern feels most natural with data streams. By implementing it that way, it allows us to implement an ECS compute service into existing software which could reduce our compute demand by up to 100x, which in return reduces costs and scales better.</p>
<p>As an example we could implement an MQTT interface into existing software, that sends a very compact SoA block of data to our ECS microservice to compute and after it is done it returns the chunk of computed data. A messaging service also makes it very easy to scale up the ECS microservices even across multiple devices.</p>
<h1 id="concepts-of-dod">Concepts of DOD</h1>
<h2 id="array-of-struct-aos-vs-struct-of-array-soa">Array of Struct (AoS) vs Struct of Array (SoA)</h2>
<p>SoA over AoS is a core concept of DOD and is responsible to structure data efficiently on CPU or memory to process it faster and more efficient.</p>
<p><strong>AoS</strong> is commonly used in OOP and looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Person</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;</span> <span class="n">personList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>SoA</strong> looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">People</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">string</span><span class="p">[]</span> <span class="n">names</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span><span class="p">[]</span> <span class="n">ages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>(There is also AoSoA, which combines both paradigms to slice the data into chunks that fit the SIMD vector size.)</p>
<p>Now imagine we want to iterate over all the names. This would look something like this in the CPU:</p>
<p>
  <img src="/posts/img/SH-DataOrientedDesignECS/diagram1.png" alt="diagram01">

</p>
<p>As you can see the DOD approach gets rid of unneeded overhead.</p>
<h2 id="data-locality">Data Locality</h2>
<p>The closer the data is to your CPU, the faster it can be accessed. I have put together a table with the levels of storage including the size and approximate access time (<a href="https://stackoverflow.com/questions/4087280/approximate-cost-to-access-various-caches-and-main-memory">Source</a>).</p>
<table>
<thead>
<tr>
<th>Label</th>
<th>Size</th>
<th style="text-align:right">access time</th>
</tr>
</thead>
<tbody>
<tr>
<td>L1 Cache</td>
<td>512KB</td>
<td style="text-align:right">1ns</td>
</tr>
<tr>
<td>L2 Cache</td>
<td>4MB</td>
<td style="text-align:right">4ns</td>
</tr>
<tr>
<td>L3 Cache</td>
<td>32MB</td>
<td style="text-align:right">20ns</td>
</tr>
<tr>
<td>Memory</td>
<td>32GB</td>
<td style="text-align:right">100ns</td>
</tr>
<tr>
<td>SSD Storage</td>
<td>1TB</td>
<td style="text-align:right">16000ns</td>
</tr>
</tbody>
</table>
<p>As you can see, the access time changes drastically depending on where the data is located. Therefore we want to optimize the usage of L1 and L2 cache.</p>
<h2 id="bottom-up-query">&ldquo;Bottom Up&rdquo; Query</h2>
<p>With the term “bottom up” query, I am referring to the process of accessing data from bottom to top rather than from top to bottom. This approach allows us to structure our data differently and in my experience it works better when dealing with data arranged in columns.</p>
<p>Let&rsquo;s consider an example where we have a populated data collection of employees and we want to query for employees named &ldquo;Hans&rdquo;:</p>
<p>Top Down:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="n">employees</span> <span class="c1">//rows of employees</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">employee</span> <span class="p">=&gt;</span> <span class="n">employee</span><span class="p">.</span><span class="n">firstname</span> <span class="p">==</span> <span class="s">&#34;Hans&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>Bottom Up:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="n">firstnames</span> <span class="c1">//column of names</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">Of</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;()</span> <span class="c1">//further reduction of dataset by flag</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">firstname</span> <span class="p">=&gt;</span> <span class="n">firstname</span> <span class="p">==</span> <span class="s">&#34;Hans&#34;</span><span class="p">)</span> <span class="c1">//get indices</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">Fetch</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;();</span> <span class="c1">//fetch employees</span>
</span></span></code></pre></div><p>In the first case we iterate over all the employees and open them up looking for those named &ldquo;Hans&rdquo;. In the second case we only retrieve the column <code>firstnames</code> and, before we iterate, we eliminate all rows that are not of type <code>Employee</code>.</p>
<h2 id="keeping-data-dumb">Keeping Data Dumb</h2>
<p>Early on in OOP and Domain-Driven Design (DDD) we learn that we should validate our data as close as possible to the data-object to restrict other developers from instantiating invalid objects. This means that in C# you will sometimes see code like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">string</span> <span class="n">firstname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">string</span> <span class="n">Firstname</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">firstname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">set</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="k">value</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">$&#34;{nameof(Employee)}.{nameof(Firstname)} cannot be null or empty&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstname</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Employee</span> <span class="p">:</span> <span class="n">Person</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">SomewhereElse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">void</span> <span class="n">Foo</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">&#34;Starting program...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">nameList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//populate nameList from a csv</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">employeeList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span> <span class="k">in</span> <span class="n">nameList</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">employeeList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span>                    
</span></span><span class="line"><span class="cl">                    <span class="k">new</span> <span class="n">Employee</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Firstname</span> <span class="p">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Logger</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">$&#34;Person {name} was successfully read.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Logger</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//write to DB and handle DB error</span>
</span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">&#34;Employees were written to DB.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">&#34;Stopping program&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>I have come across code like this several times and there are lots of points we can improve upon:</p>
<ol>
<li><strong>throwing an exception</strong> → an exception is an interrupt, which means the thread will stop whatever else it is doing and build&amp;throw the exception first</li>
<li><strong>logging</strong> → logging could be its own topic, but two short pointers here: clear and short messages (stop logging stack traces, please); only log what you will read</li>
<li><strong>inheritance</strong> → inheritance is considered bad practice and we want to use composition wherever possible instead</li>
<li><strong>mutable object</strong> → an employee is a rather static object and won&rsquo;t change a lot in the flow of a program. Making it read-only will yield up to 2x performance</li>
<li><strong>constructor</strong> → using an empty constructor here also breaks the upside of DDD principles, because it allows us to create an invalid <code>Employee</code>.</li>
<li><strong>sealed class</strong> → sealed classes will restrict the object from being further inherited from and yields vast performance increases (credit to Nick Chapsas YT here: <a href="https://youtu.be/d76WWAD99Yo">https://youtu.be/d76WWAD99Yo</a>)</li>
<li><strong>using <code>List</code> everywhere</strong> → one could argue that it is ok in this context, but I have also seen Senior Developers only working with <code>List</code>s instead of using the correct Data Collection for the job, because they feel most comfortable with <code>List</code>s.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">readonly</span> <span class="k">struct</span> <span class="nc">Person</span><span class="p">{</span>    
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">Firstname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">Person</span><span class="p">(</span><span class="kt">string</span> <span class="n">firstname</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Firstname</span> <span class="p">=</span> <span class="n">firstname</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">readonly</span> <span class="k">struct</span> <span class="nc">Employee</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">readonly</span> <span class="n">Person</span> <span class="n">Person</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">Employee</span><span class="p">(</span><span class="n">Person</span> <span class="n">person</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Person</span> <span class="p">=</span> <span class="n">person</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">SomewhereElse</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">void</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">nameList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//populate nameList from a csv</span>
</span></span><span class="line"><span class="cl">        <span class="kt">var</span> <span class="n">employeeList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Employee</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">errorCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">name</span> <span class="k">in</span> <span class="n">nameList</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">errorCount</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span> <span class="c1">//jumps to next name in list</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">person</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">employeeList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Employee</span><span class="p">(</span><span class="n">person</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">employeeList</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//write to DB and handle DB error</span>
</span></span><span class="line"><span class="cl">            <span class="n">Logger</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">$&#34;Operation succeeded. {employeeList.Count()} employees were successfully written and {errorCount} could not be written&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Logger</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="s">$&#34;No valid employees to be written. {errorCount} invalid employee lines.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>You can see that the second example already has a much calmer flow to it.</p>
<h2 id="summary">Summary</h2>
<p>Up to this point I tried to highlight DOD concepts that are also partially incorporated in modern best practices which are reflected in recent language changes, especially in C#.
Now the key concepts of DOD I take into everyday programming are:</p>
<ul>
<li>use value types wherever possible</li>
<li>use the correct collections for the right job</li>
<li>reduce boxing and/or inheritance wherever possible (use interfaces and pure functions over inheritance)</li>
<li>to compute large amounts of datasets, try to work with chunks and keep the data separate from business logic</li>
<li>know how your computer works. For C# there is <a href="https://sharplab.io/">sharplab.io</a> where you can view your code as IL or JIT asm. Also don&rsquo;t be scared to run benchmarks.</li>
</ul>
<p>We also try to incorporate the main two concepts of functional programming, because many consider them best practice for most programming approaches. 
Those are:</p>
<ul>
<li>immutability</li>
<li>pure functions</li>
</ul>
<p>All of this also goes hand in hand with my preferred test strategy, which is Test-Driven Development. However, I just write unit tests and do not mock anything.</p>
<p>An in-depth discussion of modern best practices is certainly worth several articles by itself.</p>
<h1 id="entity-component-system---ecs">Entity Component System - ECS</h1>
<p>ECS will be less practical for the average programmer, since you probably won&rsquo;t start writing your own ECS framework/language or will not be working with it in the near future. However, it employs very interesting concepts and tackles the following tradeoff problem:</p>
<p>
  <img src="/posts/img/SH-DataOrientedDesignECS/diagram2.png" alt="diagram02">

</p>
<p>In this diagram, we can see that most of our languages must sacrifice either major parts of readability or performance.</p>
<p>Entity Component System is an architectural pattern that brings all the benefits of DOD together and wraps it into readable and easy to write code. Therefore increasing performance AND readability. It consists, as the name suggests, of 3 (sometimes 4 or more) major parts. ECS is written as &ldquo;Entity Component System&rdquo;, but it makes more sense to picture it as &ldquo;Entities, Components, Systems&rdquo;. Because these parts are all seperate patterns, but together they form a cohesive architecture:</p>
<ol>
<li>Entities - are indices that point to its components → forming a composition</li>
<li>Components - are the raw data components</li>
<li>Systems - are behaviours that change components → functions</li>
<li>(Archetypes - this is a composition indexer of components that acts as a template to create/query entities)</li>
</ol>
<p>These parts are most of the time handled by a manager class. These manager classes give the ECS parts its purpose:</p>
<ol>
<li>EntityManager - handles indexing and instantiation of entities and its data</li>
<li>ComponentManager - basically a column-based dataengine</li>
<li>SystemManager - computes components; responsible to manage the order of systems</li>
</ol>
<p>You can think of these managers of what would be built into the programming language itself, if there was an ECS programming language.</p>
<p>Now let&rsquo;s see what ECS can look like in use:</p>
<h3 id="components">Components</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">struct</span> <span class="nc">PositionComponent</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">struct</span> <span class="nc">MovementComponent</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>These 2 get constantly updated, so we refrain from immutability this time.</p>
<h3 id="archetype">Archetype</h3>
<p>I included it here to give you an idea of what archetypes are typically used for. You can see the usage of it in the entities and systems section.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">readonly</span> <span class="k">struct</span> <span class="nc">Archetype</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">readonly</span> <span class="n">Type</span><span class="p">[]</span> <span class="n">componentTypes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">Archetype</span><span class="p">(</span><span class="k">params</span> <span class="n">Type</span><span class="p">[]</span> <span class="n">componentTypes</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">componentTypes</span> <span class="p">=</span> <span class="n">componentTypes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="entities">Entities</h3>
<p>Since entities are just pointers usually held by the EntityManager, I just display an example instantiation of entities here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="n">EntityManager</span> <span class="n">em</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EntityManager</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="p">&lt;</span><span class="n">PositionComponent</span><span class="p">&gt;</span> <span class="n">playerPositions</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="p">&lt;</span><span class="n">MovementComponent</span><span class="p">&gt;</span> <span class="n">playerMovement</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Archetype</span> <span class="n">personArchetype</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Archetype</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">PositionComponent</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">MovementComponent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100000</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">playerPositions</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PositionComponent</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">playerMovement</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MovementComponent</span><span class="p">.</span><span class="n">Random</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">em</span><span class="p">.</span><span class="n">CreateEntities</span><span class="p">(</span><span class="n">personArchetype</span><span class="p">,</span> <span class="n">playerPositions</span><span class="p">,</span> <span class="n">playerMovement</span><span class="p">);</span>
</span></span></code></pre></div><h3 id="systems">Systems</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="c1">//with Archetypes</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">MovementSystem</span><span class="p">(</span><span class="n">Entities</span> <span class="n">entities</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">entities</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">Of</span><span class="p">(</span><span class="n">personArchetype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">ForEach</span><span class="p">((</span><span class="k">ref</span> <span class="n">PositionComponent</span> <span class="n">pos</span><span class="p">,</span> <span class="k">in</span> <span class="n">MovementComponent</span> <span class="n">move</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pos</span> <span class="p">+=</span> <span class="n">move</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">Schedule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="c1">//without Archetypes</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">MovementSystem</span><span class="p">(</span><span class="n">Entities</span> <span class="n">entities</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">entities</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">MovementComponent</span><span class="p">&gt;()</span> <span class="c1">//also .WithOut&lt;&gt;()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">PositionComponent</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">ForEach</span><span class="p">((</span><span class="k">ref</span> <span class="n">PositionComponent</span> <span class="n">pos</span><span class="p">,</span> <span class="k">in</span> <span class="n">MovementComponent</span> <span class="n">move</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pos</span> <span class="p">+=</span> <span class="n">move</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">ScheduleParallel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is the gist of ECS.</p>
<p>I have gathered a list here of 13 ECS frameworks spanning all kinds of languages:</p>
<ul>
<li>Unity (C#)
<ul>
<li><a href="https://unity.com/dots">DOTS</a> (<a href="https://docs.unity3d.com/Packages/com.unity.entities@1.0/manual/index.html">Documentation</a>)</li>
</ul>
</li>
<li>C/C++
<ul>
<li><a href="https://github.com/skypjack/entt">entt</a></li>
<li><a href="https://github.com/SanderMertens/flecs">Flecs</a> (<a href="https://github.com/SanderMertens/ecs-faq">ECS FAQ by the creator</a>)</li>
<li><a href="https://github.com/alecthomas/entityx">EntityX</a></li>
<li><a href="https://github.com/miguelmartin75/anax">anax</a></li>
<li><a href="https://github.com/phisko/kengine">Kengine</a></li>
<li><a href="https://github.com/vittorioromeo/ecst">ecst</a></li>
<li>&hellip;</li>
</ul>
</li>
<li>C#
<ul>
<li><a href="https://github.com/sebas77/Svelto.ECS">Svelto</a></li>
<li><a href="https://github.com/Doraku/DefaultEcs">DefaultEcs</a></li>
<li><a href="https://github.com/PeteyChan/SimpleECS">SimpleECS</a></li>
</ul>
</li>
<li>Rust
<ul>
<li><a href="https://github.com/amethyst/specs">Specs</a></li>
</ul>
</li>
<li>Python
<ul>
<li><a href="https://github.com/benmoran56/esper">esper</a></li>
</ul>
</li>
<li>Kotlin
<ul>
<li><a href="https://github.com/Quillraven/Fleks">Fleks</a> (created by a colleague at NTT DATA, Simon Klausner :D)</li>
</ul>
</li>
<li>Lists by other people
<ul>
<li><a href="https://github.com/jslee02/awesome-entity-component-system">awesome-ecs</a></li>
</ul>
</li>
</ul>
<p>My work with Unity DOTS or Data-Oriented Tech Stack in the past is what first triggered my passion for DOD and ECS. 
I am currently planning my own ECS programming language, doing benchmarks and everything, which is also why I wanted to share some useful insights that I gained on my journey so far.</p>
<p>I hope that you are able to take away something from this and I think you are now deserving a relaxing break after this read :D</p>
<h1 id="credits">Credits</h1>
<p>Title image by <a href="https://www.shutterstock.com/es/g/rybarmarekk">rybarmarekk</a> on <a href="https://www.shutterstock.com">Shutterstock</a></p>

            
        </div>
        <div class="spacer"></div>
    </div>
    <div class="author-container">
        <figure class="author">
            <img src="../../authors/sascha-hampl.jpg" alt=""/>
            <figcaption>
                <h3><a href="/authors/sascha-hampl">Sascha Hampl</a><span>
                    <a target="_blank"  href="https://github.com/rushhourzet"><img class="github-author" src="/images/GitHub_blk.png"></a>
                    <a target="_blank"  href="https://gitlab.com/rushhourzet"><img class="gitlab-author" src="/images/GitLab_blk.png"></a>
                    
                </span></h3>
                <p>Technical Consultant</p>

            </figcaption>
        </figure>
        
    </div>
    
    

    <div class="related-container">
        
        
        
        <div class="related-block">
            
            
            
            

        </div>
    </div>
    

    
    
    <div class="footer-wrapper">
        <div class="footer-container">
            <h2 class="footer">Article Tags</h2>
            

<ul class="tag-list-linked">
  
  <li><a href="https://nttdata-dach.github.io/tags/entity-component-system/">Entity Component System</a> </li>
  
  <li><a href="https://nttdata-dach.github.io/tags/data-oriented-design/">Data-Oriented Design</a> </li>
  
  <li><a href="https://nttdata-dach.github.io/tags/array-of-struct/">Array of Struct</a> </li>
  
  <li><a href="https://nttdata-dach.github.io/tags/computing/">Computing</a> </li>
  
  <li><a href="https://nttdata-dach.github.io/tags/data-streams/">Data-Streams</a> </li>
  
</ul>
        </div>
    </div>
    
</main>




</main>

<footer>
  <a href="/"><img src="/images/NTT-Data-white.png"></a>
  <nav>
    
    <a  href="/imprint">Imprint</a>
    
    <a  href="/privacy">Privacy Notice</a>
    
    <a  href="/legal">Legal Notice</a>
    
    <a  href="mailto:techblog@nttdata.com">Contact</a>
    
  </nav>

  <p class="text">Copyright 2023 NTT DATA Deutschland SE - This site does not use any cookies</p>

  <div>
    <span class="first"><a href="https://de.nttdata.com/" target="_blank" rel="noopener noreferrer">de.nttdata.com</a></span>
    
    <a class="top" href="#">back to top &#8679;</a>
  </div>

</footer>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]} })
</script>

</body>

</html>
